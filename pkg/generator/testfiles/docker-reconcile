#!/bin/bash

mkdir -p '/var/lib/kubelet'
cat << EOF | base64 -d > '/var/lib/kubelet/ca.crt'
c2VjcmV0UmVmOgpuYW1lOiBkZWZhdWx0LXRva2VuLWQ5bnpsCmRhdGFLZXk6IHRva2Vu
EOF
chmod '0644' '/var/lib/kubelet/ca.crt'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/g_functions.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKZnVuY3Rpb24gZ2V0X2ZzX29mX2RpcmVjdG9yeSB7CiAgICBbIC16ICIkMSIgXSB8fCBbICEgLWQgIiQxIiBdICYmIHJldHVybgogICAgZWNobyAtbiAiJChzdGF0IC1jICVUIC1mICIkMSIpIgp9CgpmdW5jdGlvbiBjaGVja19jdXJyZW50X2Nncm91cCB7CiAgICAjIGRldGVybWluaW5nIGlmIHRoZSBzeXN0ZW0gaXMgcnVubmluZyBjZ3JvdXB2MSBvciBjZ3JvdXB2MgogICAgIyB1c2luZyBzeXN0ZW1kIGFwcHJvYWNoIGFzIGluCiAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS9zeXN0ZW1kL3N5c3RlbWQvYmxvYi9kNmQ0NTAwNzRmZjc3MjlkNDM0NzY4MDRlMGUxOWMwNDljMDMxNDFkL3NyYy9iYXNpYy9jZ3JvdXAtdXRpbC5jI0wyMTA1LUwyMTQ5CgogICAgQ0dST1VQX0lEPSJjZ3JvdXBmcyIKICAgIENHUk9VUDJfSUQ9ImNncm91cDJmcyIKICAgIFRNUEZTX0lEPSJ0bXBmcyIKCiAgICBjZ3JvdXBfZGlyX2ZzPSIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXApIgoKICAgIGlmIFtbICIkY2dyb3VwX2Rpcl9mcyIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgIGVjaG8gInYyIgogICAgICAgIHJldHVybgogICAgZWxpZiBbWyAiJGNncm91cF9kaXJfZnMiID09ICIkVE1QRlNfSUQiIF1dOyB0aGVuCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC91bmlmaWVkKSIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSAoY2dyb3VwdjJzeXN0ZW1kKSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3N5c3RlbWQpIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIChjZ3JvdXB2MnN5c3RlbWQyMzIpIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCkiID09ICIkQ0dST1VQX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgIGZpCiAgICAjIGlmIHdlIGNhbWUgdGhpcyBmYXIgZGVzcGl0ZSBhbGwgdGhvc2UgcmV0dXJucywgaXQgbWVhbnMgc29tZXRoaW5nIHdlbnQgd3JvbmcKICAgIGVjaG8gImZhaWxlZCB0byBkZXRlcm1pbmUgY2dyb3VwIHZlcnNpb24gZm9yIHRoaXMgc3lzdGVtIiA+JjIKICAgIGV4aXQgMQp9Cg==
EOF
chmod '0755' '/opt/gardener/bin/g_functions.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/kubelet_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKIyByZWNvbmZpZ3VyZSB0aGUga3ViZWxldCB0byB1c2Ugc3lzdGVtZCBhcyBhIGNncm91cCBkcml2ZXIgb24gY2dyb3VwIHYyIGVuYWJsZWQgc3lzdGVtcwpmdW5jdGlvbiBjb25maWd1cmVfa3ViZWxldCB7CiAgICBkZXNpcmVkX2Nncm91cD0kMQogICAgS1VCRUxFVF9DT05GSUc9Ii92YXIvbGliL2t1YmVsZXQvY29uZmlnL2t1YmVsZXQiCgogICAgaWYgWyAhIC1zICIkS1VCRUxFVF9DT05GSUciIF07IHRoZW4KICAgICAgICBlY2hvICIkS1VCRUxFVF9DT05GSUcgZG9lcyBub3QgZXhpc3QiID4mMgogICAgICAgIHJldHVybgogICAgZmkKCiAgICBpZiBbWyAiJGRlc2lyZWRfY2dyb3VwIiA9PSAidjIiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiQ29uZmlndXJpbmcga3ViZWxldCB0byB1c2Ugc3lzdGVtZCBhcyBjZ3JvdXAgZHJpdmVyIgogICAgICAgIHNlZCAtaSAicy9jZ3JvdXBEcml2ZXI6IGNncm91cGZzL2Nncm91cERyaXZlcjogc3lzdGVtZC8iICIkS1VCRUxFVF9DT05GSUciCiAgICBlbHNlCiAgICAgICAgZWNobyAiQ29uZmlndXJpbmcga3ViZWxldCB0byB1c2UgY2dyb3VwZnMgYXMgY2dyb3VwIGRyaXZlciIKICAgICAgICBzZWQgLWkgInMvY2dyb3VwRHJpdmVyOiBzeXN0ZW1kL2Nncm91cERyaXZlcjogY2dyb3VwZnMvIiAiJEtVQkVMRVRfQ09ORklHIgogICAgZmkKfQoKY29uZmlndXJlX2t1YmVsZXQgIiQoY2hlY2tfY3VycmVudF9jZ3JvdXApIgo=
EOF
chmod '0755' '/opt/gardener/bin/kubelet_cgroup_driver.sh'



cat << EOF | base64 -d > '/etc/systemd/system/unit1'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF
cat << EOF | base64 -d > '/etc/systemd/system/unit2'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF

mkdir -p '/etc/systemd/system/unit2.d'
cat << EOF | base64 -d > '/etc/systemd/system/unit2.d/dropin'
W1NlcnZpY2VdCkVudmlyb25tZW50PSJET0NLRVJfT1BUUz0tLWxvZy1vcHQgbWF4LXNpemU9NjBtIC0tbG9nLW9wdCBtYXgtZmlsZT0zIg==
EOF


mkdir -p '/etc/systemd/system/kubelet.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/kubelet.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9rdWJlbGV0X2Nncm91cF9kcml2ZXIuc2gK
EOF

grep -sq "^nfsd$" /etc/modules || echo "nfsd" >>/etc/modules
modprobe nfsd
nslookup $(hostname) || systemctl restart systemd-networkd

systemctl daemon-reload